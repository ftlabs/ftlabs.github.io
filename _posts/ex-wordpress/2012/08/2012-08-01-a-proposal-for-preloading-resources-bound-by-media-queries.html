---
layout: wp-post
title: 'A proposal for preloading resources bound by media queries'
date: 2012-08-01
categories: ex-wordpress
permalink: /2012/08/a-proposal-for-preloading-resources-bound-by-media-queries/
author: robertshilston
---
					<div class="date">by <a href="../../../author/robert/index.html">Robert Shilston</a>, <time class="entry-date" datetime="2012-08-13T11:09:28+00:00" pubdate>13 August 2012</time></div>					<p>If you use <a href="https://developer.mozilla.org/en/CSS/Media_queries/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://developer.mozilla.org/en/CSS/Media_queries/', 'media queries');">media queries</a> to vary which resources your page uses, it&#8217;s worth considering at what point those resources should be downloaded.  On the one hand, a user agent could download all resources specified in a stylesheet regardless of whether the associated media query condition is currently satisifed.  Proactive pre-fetching promotes a smoother user experience in cases such as orientation change, where the re-layout and rendering of the page content should be completed as quickly as possible.  On the other hand, pre-fetching may result in downloading resources that are not ultimately used, wasting possibly metered or capped data allowance and device memory.</p>
<p>Following the meeting of the <a href="http://lists.w3.org/Archives/Public/public-coremob/2012Jul/0055.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://lists.w3.org/Archives/Public/public-coremob/2012Jul/0055.html', 'W3C CoreMobile Commuity group in Palo Alto last month');">W3C CoreMobile Commuity group in Palo Alto last month</a>, we took an action to produce a document discussing this issue, so this is our response.  As it turns out, the issue is thornier than we thought.</p>
<p>In current implementations as of August 2012, no popular user agent pre-fetches resources that are subject to media queries until those media queries are satisfied.  However, it seems like a more intelligent approach could be taken based on the liklihood that the media query <em>may</em> be satisfied at some point after a page has loaded.  </p>
<p>Some media features are liable to change as a result of user interaction with the page content, the device OS, or the physical handling of the device itself.  Others cannot change without a fundamental hardware change on the device which is unlikely to happen while a webpage remains open.  And in some cases the volatility of the feature value is dependent on whether certain behaviour is supported (or indeed has any meaning) for the device in question.   </p>
<p>For example, <code>orientation</code> and <code>device-width</code> may change as a result of rotating a device, but only if the device is capable of being rotated.  A tablet or phone would support this behaviour, while a desktop computer typically would not.</p>
<p>Other properties are typically variable on almost all platforms.  A change to <code>width</code> can be commonly expected on any device that uses a window-based UI and therefore displays the web page in a resizable viewport, or which has a non-square aspect ratio and is capable of being rotated.  </p>
<p>In contrast, <code>resolution</code> (or webkit&#8217;s non-standard and roughly equivilent <code>device-pixel-ratio</code>) will not change unless the pixel density of the display changes.  This isn&#8217;t impossible, though currently the only situation in which this will happen is with an <a href="http://en.wikipedia.org/wiki/MacBook_Pro#Third_generation_.28Retina.29" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://en.wikipedia.org/wiki/MacBook_Pro#Third_generation_.28Retina.29', 'Apple MacBook Pro with Retina display');">Apple MacBook Pro with Retina display</a> hooked up to a standard-density external monitor.  When a webpage is dragged from the high density screen to the low density one, the value of the <code>device-pixel-ratio</code> media feature changes from 2 to 1 (we owe the staff of the Apple store in London thanks for letting us try this!)</p>
<p>Since such edge cases as these exist, it is unwise to suggest that any media feature value is always constant.  However, it is true to say that the probability of values changing post-pageload is significantly higher for some media features than for others, and that probability varies from one class of device to another.</p>
<p>To try and optimise for these variations is hard.  To take the orientation change use case, when on a device where orientation change is a possibility, we may like to preload the graphics for the inactive orientation, so that when the device is rotated the images are already in cache.  However, if we&#8217;re also providing high-resolution versions of both the portrait and landscape images, we only want to preload the ones that apply to the active pixel density (since pixel density, as discussed earlier, is far less likely to change).</p>
<p>I said &#8216;may&#8217;, and here lies the further complication &#8211; the way the app is designed is important too.  Some pages may be designed to invite rotation, while on others it may be less desirable.  So different developers building apps for the same device might differ in their opinions about whether some specific case of preloading is worth doing.</p>
<p>So, we cannot simply preload everything, and we cannot have a &#8216;prefetch&#8217; flag on a media query because it may be a compound query containing tests for features that are likely to change in combination with other features that are not.  We should not flag a media feature for prefetch, since the volatility of that feature may be device dependent.</p>
<h2>media-preload-hint</h2>
<p>I&#8217;d therefore like to suggest a new CSS block rule called <code>media-preload-hint</code>.  This would contain a code block qualified by a standard media query, but instead of CSS properties, the block would contain media features with ranges that the developer wishes to preload for.</p>
<pre class="prettyprint linenums"><code>@media-preload-hint screen {
  width: 0-1000px;
  orientation:portrait,landscape;
}</code></pre>
<p>In this example, the developer expresses a preference that on screen based media, the user agent should preload any media query resources that would be required if the <code>width</code> feature were to have a value of between 0 and 1000 and if the <code>orientation</code> feature were to have a value of portrait or landscape (disregarding what the actual values are at pageload).  A media query that contains a conditional test of a feature not specified in a preload hint will only be preloaded if that part of the query is satisfied on page load.  For example, this is how the <code>media-preload-hint</code> clause shown above would affect some real media queries:</p>
<pre class="prettyprint linenums"><code>@media (orientation:portrait){}  /* Preload */
@media (min-width:600px) {} /* Preload */
@media (orientation:landscape) and (min-resolution:180dpi) {} /* Preload if on high-density screen */
@media (min-device-height:400px) {} /* Don't preload */</code></pre>
<p>This solution is flexible and powerful, because as well as respecting compound queries, it allows for multiple preload-hints that are themselves restricted by media query (in the examples above, preloading would only ever happen on screen based media because the preload hint would not apply to any other media type).</p>
<p>The syntax for media-preload-hint would be, in more complete terms:</p>
<pre class="prettyprint linenums"><code>@media-preload-hint &lt;MEDIA-QUERY&gt; {
  &lt;MEDIA-FEATURE&gt;: [&lt;RANGE&gt;|&lt;LIST&gt;|*];
  ...
}</code></pre>
<p>Those media features that have continuous values, such as a length, ratio, resolution or integer, would have a preload range (eg <code>0-1000px</code>), while those with discrete values would have a comma delimited preload list (eg. <code>landscape,portrait</code>).  Any media feature can have a preload value of <code>*</code> meaning that feature should be considered preloadable regardless of its value.</p>
<p>Finally, this is a hint precisely because the user agent will know more than the developer about the capabilities of a device, and should apply that knowledge where appropriate.   The hint declares the developer&#8217;s view of what is likely to be required, and the user agent should not be required to comply if it can do better.</p>
